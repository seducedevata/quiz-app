<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Ultra-fast startup optimization
        console.time('‚ö° DOM Ready');
        
        // Hardware acceleration detection
        window.hardwareProfile = {
            cores: navigator.hardwareConcurrency || 2,
            memory: navigator.deviceMemory || 4,
            timing: performance.now()
        };
        
        // Preload critical resources
        const preloadLinks = [
            'app.js',
            'styles.css'
        ];
        
        preloadLinks.forEach(href => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = href;
            link.as = href.endsWith('.js') ? 'script' : 'style';
            document.head.appendChild(link);
        });
        
        // Fast initialization queue
        window.fastInit = {
            critical: [],
            background: [],
            runCritical: function() {
                return Promise.all(this.critical.map(fn => fn()));
            },
            runBackground: function() {
                requestIdleCallback(() => {
                    this.background.forEach(fn => fn());
                });
            }
        };
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge App</title>
    <link rel="stylesheet" href="styles.css">
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="fix_button_overlap.js"></script>
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['noerrors', 'textmacros', 'ams', 'newcommand', 'mathtools']},
                tags: 'none',
                macros: {
                    // Add common macros for physics and chemistry
                    degree: '^{\\circ}',
                    angstrom: '\\text{√Ö}',
                    celsius: '^{\\circ}\\text{C}',
                    kelvin: '\\text{K}',
                    joule: '\\text{J}',
                    kilojoule: '\\text{kJ}',
                    mol: '\\text{mol}',
                    electronvolt: '\\text{eV}',
                    meter: '\\text{m}',
                    nanometer: '\\text{nm}',
                    picometer: '\\text{pm}',
                    bohr: 'a_0'
                },
                formatError: function (jax, error) {
                    console.warn('üîß MathJax format error:', error.message);
                    console.warn('üîß Problematic input:', jax.math);
                    // Return the original text instead of error message
                    return ['span', {style: 'font-family: monospace; color: #333;'}, jax.math];
                },
                // üöÄ CRITICAL FIX: Add numeric error handler to prevent NaN values
                processError: function (math, error) {
                    console.warn('üîß MathJax processing error:', error.message);
                    console.warn('üîß Math content:', math);
                    // Return safe fallback content
                    return ['span', {
                        style: 'font-family: monospace; color: #666; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;'
                    }, '[Math Error: ' + (math || 'unknown') + ']'];
                }
            },
            svg: {
                fontCache: 'global',
                displayAlign: 'left',
                displayIndent: '0',
                // üöÄ CRITICAL FIX: Add safe defaults to prevent NaN values
                scale: 1.0,
                minScale: 0.5,
                maxScale: 2.0,
                // Error recovery for SVG rendering
                internalSpeechTitles: false,
                useFontCache: true,
                useGlobalCache: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/textmacros', '[tex]/ams', '[tex]/newcommand', '[tex]/mathtools']
            },
            startup: {
                typeset: true,  // ‚úÖ ENABLE AUTO TYPESETTING
                ready() {
                    console.log('‚úÖ MathJax startup completed successfully');
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                    
                    // Add error recovery for rendering
                    if (MathJax.startup.document && MathJax.startup.document.menu) {
                        MathJax.startup.document.menu.settings.errorSettings = {
                            message: ['[Math Processing Error]'],
                            style: {color: '#CC0000', 'font-size': '90%'}
                        };
                    }
                    
                    // ‚úÖ CRITICAL FIX: Auto-render math in dynamically added content
                    window.renderMathInElement = function(element) {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            return MathJax.typesetPromise([element]).catch(err => {
                                console.warn('MathJax rendering error:', err);
                            });
                        }
                        return Promise.resolve();
                    };
                    
                    // ‚úÖ Set up mutation observer for auto-rendering
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach((node) => {
                                    if (node.nodeType === Node.ELEMENT_NODE) {
                                        // Check if the added element contains math
                                        if (node.textContent && (node.textContent.includes('$') || node.textContent.includes('\\('))) {
                                            setTimeout(() => window.renderMathInElement(node), 10);
                                        }
                                    }
                                });
                            }
                        });
                    });
                    
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                    
                    console.log('‚úÖ MathJax auto-rendering set up');
                }
            }
        };
        
        // Enhanced MathJax loading detection with retry mechanism
        window.addEventListener('load', function() {
            console.log('üîç Window loaded, checking MathJax status...');
            let retryCount = 0;
            const maxRetries = 10;
            
            function checkMathJaxReady() {
                if (window.MathJax && window.mathJaxReady && window.MathJax.typesetPromise) {
                    console.log('‚úÖ MathJax fully ready');
                    return true;
                } else if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`üîÑ MathJax not ready, retry ${retryCount}/${maxRetries}`);
                    setTimeout(checkMathJaxReady, 500);
                    return false;
                } else {
                    console.warn('‚ö†Ô∏è MathJax failed to load after maximum retries');
                    return false;
                }
            }
            
            checkMathJaxReady();
        });
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
            onload="console.log('‚úÖ MathJax script loaded from CDN'); window.mathJaxLoaded = true;"
            onerror="console.error('‚ùå Failed to load MathJax from CDN'); loadOfflineMathJax();"></script>

    <script>
        // Offline MathJax fallback
        function loadOfflineMathJax() {
            console.log('üîÑ Attempting to load offline MathJax fallback...');

            // Set flag for offline mode
            window.mathJaxOfflineMode = true;

            // Try to load local MathJax if available
            const localScript = document.createElement('script');
            localScript.src = 'mathjax/tex-mml-chtml.js'; // Local fallback path
            localScript.async = true;
            localScript.onload = function() {
                console.log('‚úÖ Local MathJax loaded successfully');
                window.mathJaxLoaded = true;
            };
            localScript.onerror = function() {
                console.warn('‚ö†Ô∏è Local MathJax not available, using text-based fallback');
                window.mathJaxLoaded = false;
                window.mathJaxOfflineMode = true;
                initializeOfflineMathRenderer();
            };

            document.head.appendChild(localScript);
        }

        function initializeOfflineMathRenderer() {
            console.log('üîß Initializing offline math renderer...');

            // Simple text-based math renderer for offline mode
            window.OfflineMathRenderer = {
                renderMath: function(element) {
                    if (!element) return Promise.resolve();

                    const mathElements = element.querySelectorAll('[data-math]');
                    mathElements.forEach(mathEl => {
                        const mathText = mathEl.getAttribute('data-math');
                        mathEl.innerHTML = `<span class="math-fallback">${mathText}</span>`;
                    });

                    return Promise.resolve();
                }
            };

            console.log('‚úÖ Offline math renderer initialized');
        }

        // Check MathJax availability after page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!window.mathJaxLoaded && !window.mathJaxOfflineMode) {
                    console.log('üîÑ MathJax not loaded after timeout, switching to offline mode');
                    loadOfflineMathJax();
                }
            }, 5000); // 5 second timeout
        });
    </script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">Knowledge App</h1>
                <p class="app-subtitle">Modern Learning Platform</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Navigation -->
            <nav class="side-nav">
                <button class="nav-item active" onclick="showScreen('home', this)">
                    <span class="icon">üè†</span>
                    <span>Home</span>
                </button>
                <button class="nav-item" onclick="showScreen('quiz', this)">
                    <span class="icon">üìù</span>
                    <span>Quiz</span>
                </button>
                <button class="nav-item" onclick="showScreen('review', this)">
                    <span class="icon">üìö</span>
                    <span>Review</span>
                </button>
                <button class="nav-item" onclick="showScreen('train', this)">
                    <span class="icon">üß†</span>
                    <span>Train Model</span>
                </button>
                <button class="nav-item" onclick="showScreen('settings', this)">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Home Screen -->
                <div id="home-screen" class="screen active">
                    <div class="welcome-card">
                        <h2>Welcome to Knowledge App</h2>
                        <p>Test your knowledge with AI-powered quizzes</p>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>0</h3>
                                <p>Quizzes Taken</p>
                            </div>
                            <div class="stat-card">
                                <h3>0%</h3>
                                <p>Average Score</p>
                            </div>
                            <div class="stat-card">
                                <h3>0</h3>
                                <p>Questions Answered</p>
                            </div>
                        </div>
                        <!-- Dashboard Analytics - Use sidebar to navigate to Quiz -->
                        <div class="dashboard-info">
                            <p>üìä View your learning progress and statistics above</p>
                            <p>üéØ Use the sidebar to start a new quiz or review questions</p>
                        </div>
                    </div>
                </div>

                <!-- Quiz Screen -->
                <div id="quiz-screen" class="screen">
                    <div class="quiz-container">
                        <div id="quiz-setup" class="quiz-setup">
                            <h2>Quiz Setup</h2>
                            <div class="form-group">
                                <label>Topic</label>
                                <input type="text" id="quiz-topic" placeholder="Enter topic (e.g., Science, History)">
                            </div>
                            <div class="form-group">
                                <label>Mode</label>
                                <select id="quiz-mode" onchange="updateModeInfo(); saveSettings();">
                                    <option value="offline">Offline (Local AI - TURBO)</option>
                                    <option value="auto" selected>Auto (Best Available)</option>
                                    <option value="online">Online (Cloud APIs)</option>
                                </select>
                                <div id="mode-info" class="mode-info">
                                    <small>ü§ñ Auto-selecting best available method</small>
                                </div>
                            </div>
                            
                            <div id="api-status" class="api-status" style="display: none;">
                                <div class="api-providers" id="api-providers">
                                    <!-- API provider status will be shown here -->
                                </div>
                                <div class="api-help">
                                    <small>üí° <strong>Supported APIs:</strong> OpenAI GPT-4, Anthropic Claude, Google Gemini, Groq, OpenRouter</small>
                                    <br>
                                    <small>üîë <strong>Setup:</strong> Set environment variables OPENAI_API_KEY, ANTHROPIC_API_KEY, GROQ_API_KEY, etc.</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Game Mode</label>
                                <select id="quiz-game-mode" onchange="updateGameModeInfo(); saveSettings();">
                                    <option value="casual">üéµ Casual Mode (Relaxed, Music)</option>
                                    <option value="serious">‚è±Ô∏è Serious Mode (Timed, Focused)</option>
                                </select>
                                <div id="game-mode-info" class="mode-info">
                                    <small>üéµ Relaxed learning with background music and no time pressure</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Question Type</label>
                                <select id="quiz-submode" onchange="updateSubmodeInfo(); saveSettings();">
                                    <option value="mixed">üîÄ Mixed (Balanced)</option>
                                    <option value="numerical">üìä Numerical (Math & Calculations)</option>
                                    <option value="conceptual">üß† Conceptual (Theory & Understanding)</option>
                                </select>
                                <div id="submode-info" class="mode-info">
                                    <small>üîÄ Balanced mix of numerical and conceptual questions</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Difficulty</label>
                                <select id="quiz-difficulty" onchange="updateDifficultyInfo(); saveSettings();">
                                    <option value="easy">üü¢ Easy</option>
                                    <option value="medium">üü° Medium</option>
                                    <option value="hard">üî¥ Hard</option>
                                    <option value="expert">üî•üíÄ EXPERT (PhD-Level) üíÄüî•</option>
                                </select>
                                <div id="difficulty-info" class="mode-info">
                                    <small>üî¥ Advanced analysis and complex problem-solving</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Number of Questions</label>
                                <input type="number" id="quiz-questions" value="2" min="1" max="10">
                            </div>

                            <!-- üåä Token Streaming Option -->
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="token-streaming-enabled" class="toggle-checkbox" checked>
                                    <label for="token-streaming-enabled" class="toggle-label">
                                        üåä Live Token Streaming
                                        <small class="feature-description">Watch AI thinking process in real-time (Expert + Online mode only)</small>
                                    </label>
                                </div>
                            </div>

                            <!-- DeepSeek Integration -->
                            <div class="form-group deepseek-section" id="deepseek-section" style="display: none;">
                                <div class="deepseek-header">
                                    <h3>üß† DeepSeek AI Pipeline</h3>
                                    <div id="deepseek-status" class="deepseek-status">
                                        <span class="status-indicator">‚è≥</span>
                                        <span class="status-text">Checking DeepSeek availability...</span>
                                    </div>
                                </div>
                                <div class="deepseek-info">
                                    <small>üî¨ Two-Model Pipeline: DeepSeek R1 thinking + Llama JSON formatting</small>
                                    <br>
                                    <small>üéØ Optimized for expert-level, PhD-quality questions</small>
                                </div>
                            </div>

                            <!-- FIXED BUTTON WITH MULTIPLE CLICK HANDLERS -->
                            <button 
                                class="btn btn-primary" 
                                id="start-quiz-button"
                                onclick="handleStartQuizClick(event)"
                                style="background-color: #007bff; color: white; font-weight: bold; padding: 15px 30px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 1000;">
                                ‚≠ê START QUIZ
                            </button>
                        </div>

                        <div id="quiz-game" class="quiz-game" style="display: none;">
                            <!-- Status Display -->
                            <div id="status-display" class="status-display" style="display: none;">
                                <!-- Status messages will be dynamically added -->
                            </div>
                            
                            <div class="quiz-header">
                                <span id="question-number">Loading...</span>
                                <span id="quiz-timer">Time: 30s</span>
                            </div>
                            <div class="question-container">
                                <h3 id="question-text">Loading question...</h3>
                                <div id="options-container" class="options-container">
                                    <!-- Options will be dynamically added -->
                                </div>
                            </div>
                            
                            <!-- Feedback Container -->
                            <div id="feedback-container" class="feedback-container" style="display: none;">
                                <!-- Feedback will be dynamically added -->
                            </div>
                            
                            <!-- Explanation Container -->
                            <div id="explanation-container" class="explanation-container" style="display: none;">
                                <!-- Explanation will be dynamically added -->
                            </div>
                            
                            <div class="quiz-footer">
                                <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()">Submit</button>
                                <button class="btn btn-secondary" onclick="skipQuestion()">Skip</button>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div id="navigation-buttons" class="navigation-buttons" style="display: none;">
                                <button class="btn btn-secondary" onclick="showPreviousQuestion()">‚Üê Previous</button>
                                <button class="btn btn-secondary" onclick="showNextQuestion()">Next ‚Üí</button>
                                <button class="btn btn-primary" onclick="loadNextNewQuestion()">Next New Question</button>
                            </div>
                        </div>

                        <div id="quiz-results" class="quiz-results" style="display: none;">
                            <h2>Quiz Complete!</h2>
                            <div class="score-display">
                                <div class="score-circle">
                                    <span id="score-percentage">0%</span>
                                </div>
                            </div>
                            <p id="score-text">You scored 0 out of 0</p>
                            <button class="btn btn-primary" onclick="resetQuiz()">New Quiz</button>
                        </div>
                    </div>
                </div>

                <!-- Review Screen -->
                <div id="review-screen" class="screen">
                    <div class="review-container">
                        <h2>üìö Question Review & History</h2>
                        <p>Review all your previously generated questions without burning API calls or GPU resources!</p>

                        <!-- NUCLEAR OPTION: Direct Question Display -->
                        <div class="nuclear-review-section" style="background: #ffe6e6; padding: 10px; margin: 10px; border: 2px solid #ff0000;">
                            <h3>üöÄ NUCLEAR DEBUG MODE</h3>
                            <button class="btn btn-primary" onclick="nuclearLoadQuestions()" style="margin: 5px;">
                                üöÄ FORCE LOAD QUESTIONS
                            </button>
                            <button class="btn btn-secondary" onclick="nuclearTestDisplay()" style="margin: 5px;">
                                üß™ TEST DISPLAY
                            </button>
                            <div id="nuclear-debug" style="background: #f0f0f0; padding: 10px; margin: 10px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                        </div>

                        <!-- Review Controls -->
                        <div class="review-controls">
                            <div class="filter-section">
                                <h3>üîç Filters</h3>
                                <div class="filter-grid">
                                    <div class="filter-item">
                                        <label>Search Questions</label>
                                        <input type="text" id="question-search" placeholder="Search by content..." onkeyup="searchQuestions()">
                                    </div>
                                    <div class="filter-item">
                                        <label>Filter by Topic</label>
                                        <select id="topic-filter" onchange="filterQuestionsByTopic()">
                                            <option value="">All Topics</option>
                                        </select>
                                    </div>
                                    <div class="filter-item">
                                        <label>Filter by Difficulty</label>
                                        <select id="difficulty-filter" onchange="filterQuestionsByDifficulty()">
                                            <option value="">All Difficulties</option>
                                            <option value="easy">üü¢ Easy</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="hard">üî¥ Hard</option>
                                            <option value="expert">üî•üíÄ Expert</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="review-actions">
                                    <button class="btn btn-primary" onclick="loadQuestionHistory()">üîÑ Refresh History</button>
                                    <button class="btn btn-secondary" onclick="showQuestionStats()">üìä Statistics</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics Display -->
                        <div id="question-stats" class="question-stats" style="display: none;">
                            <h3>üìä Question Statistics</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <h3 id="total-questions-stat">0</h3>
                                    <p>Total Questions</p>
                                </div>
                                <div class="stat-card">
                                    <h3 id="topics-count-stat">0</h3>
                                    <p>Topics Covered</p>
                                </div>
                                <div class="stat-card">
                                    <h3 id="expert-questions-stat">0</h3>
                                    <p>Expert Level</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Questions Display -->
                        <div id="question-history-container" class="question-history-container">
                            <div id="loading-history" class="loading-message">
                                <p>‚è≥ Loading question history...</p>
                            </div>
                            <div id="no-questions" class="no-questions" style="display: none;">
                                <p>üìù No questions found. Generate some questions first!</p>
                                <button class="btn btn-primary" onclick="showScreen('quiz')">Start Quiz</button>
                            </div>
                            <div id="questions-list" class="questions-list">
                                <!-- Questions will be dynamically loaded here -->
                            </div>
                        </div>
                        
                        <!-- Question Detail Modal -->
                        <div id="question-detail-modal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Question Details</h3>
                                    <span class="modal-close" onclick="closeQuestionModal()">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <div id="modal-question-content">
                                        <!-- Question content will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Train Model Screen -->
                <div id="train-screen" class="screen">
                    <div class="train-container">
                        <div class="upload-section">
                            <h3>üìö Document Upload</h3>
                            <div class="upload-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Drag and drop files here or click to browse</p>
                                <p class="upload-hint">Supported formats: PDF, TXT, DOCX</p>
                                <input type="file" id="file-input" multiple accept=".pdf,.txt,.docx,.doc,.rtf" onchange="handleFileSelect(event)" style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                                    üìÅ Browse Files
                                </button>
                            </div>

                            <!-- Upload Progress -->
                            <div id="upload-progress" class="upload-progress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="upload-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="upload-progress-text">Uploading...</div>
                            </div>
                        </div>

                        <div id="train-content">
                            <!-- Training UI will be populated here by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Settings Screen -->
                <div id="settings-screen" class="screen">
                    <div class="settings-container">
                        <h2>Settings</h2>
                        
                        <!-- API Configuration Section -->
                        <div class="settings-section">
                            <h3>ü§ñ AI Providers</h3>
                            <p class="section-description">Configure API keys for cloud AI providers. Keys are stored locally and encrypted.</p>
                            
                            <div class="api-providers-grid">
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">üß†</span>
                                        <span class="provider-name">OpenAI</span>
                                        <span id="openai-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="openai-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                    </div>
                                    <input type="password" id="openai-api-key" placeholder="sk-..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Powers GPT-4, GPT-3.5, and other OpenAI models</small>
                                    </div>
                                </div>
                                
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">üîÆ</span>
                                        <span class="provider-name">Anthropic</span>
                                        <span id="anthropic-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="anthropic-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                    </div>
                                    <input type="password" id="anthropic-api-key" placeholder="sk-ant-..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Powers Claude 3.5 Sonnet and other Claude models</small>
                                    </div>
                                </div>
                                
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">üéØ</span>
                                        <span class="provider-name">Google Gemini</span>
                                        <span id="gemini-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="gemini-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                    </div>
                                    <input type="password" id="gemini-api-key" placeholder="AIza..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Powers Gemini Pro and other Google AI models</small>
                                    </div>
                                </div>
                                
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">‚ö°</span>
                                        <span class="provider-name">Groq</span>
                                        <span id="groq-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="groq-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                    </div>
                                    <input type="password" id="groq-api-key" placeholder="gsk_..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Ultra-fast inference with Mixtral and Llama models</small>
                                    </div>
                                </div>
                                
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">üåê</span>
                                        <span class="provider-name">OpenRouter</span>
                                        <span id="openrouter-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="openrouter-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                    </div>
                                    <input type="password" id="openrouter-api-key" placeholder="sk-or-..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Access to multiple models through one API</small>
                                    </div>
                                </div>
                                
                                <div class="api-provider-card">
                                    <div class="provider-header">
                                        <span class="provider-icon">üîç</span>
                                        <span class="provider-name">Tavily Search</span>
                                        <span id="tavily-status" class="provider-status">‚ùå</span>
                                        <label class="provider-toggle">
                                            <input type="checkbox" id="tavily-enabled" checked onchange="handleProviderChange()">
                                            <span class="toggle-text">Enable</span>
                                        </label>
                                        <button class="btn btn-small" onclick="refreshTavilyStatus()" title="Refresh Status">üîÑ</button>
                                    </div>
                                    <input type="password" id="tavily-api-key" placeholder="tvly-..." class="api-key-input" onchange="handleProviderChange()">
                                    <div class="provider-info">
                                        <small>Real-time web search for up-to-date quiz content</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="api-actions">
                                <button class="btn btn-secondary" onclick="testAllProviders()">üß™ Test All APIs</button>
                                <button class="btn btn-secondary" onclick="clearAllApiKeys()">üóëÔ∏è Clear All Keys</button>
                                <button class="btn btn-warning" onclick="resetApiKeysAdvanced()">üîÑ Advanced Reset</button>
                                <button class="btn btn-info" onclick="validateAllApiKeys()">üîç Validate Keys</button>
                            </div>
                            
                            <!-- ‚úÖ NEW: API Key Management Status -->
                            <div class="api-status-summary">
                                <div class="status-indicators">
                                    <span id="api-persistence-status">üíæ Auto-save: Active</span>
                                    <span id="api-session-status">üîÑ Session backup: Ready</span>
                                </div>
                            </div>
                            
                            <div class="api-help">
                                <details>
                                    <summary>üîë Where to get API keys</summary>
                                    <ul>
                                        <li><strong>OpenAI:</strong> <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></li>
                                        <li><strong>Anthropic:</strong> <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com/settings/keys</a></li>
                                        <li><strong>Google:</strong> <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com/app/apikey</a></li>
                                        <li><strong>Groq:</strong> <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></li>
                                        <li><strong>OpenRouter:</strong> <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></li>
                                        <li><strong>Tavily:</strong> <a href="https://tavily.com" target="_blank">tavily.com</a> (Free tier available)</li>
                                    </ul>
                                </details>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h3>Appearance</h3>
                            <div class="setting-item">
                                <label>Dark Mode</label>
                                <input type="checkbox" id="dark-mode-toggle" onchange="toggleTheme()">
                            </div>
                        </div>
                        <div class="settings-section">
                            <h3>Quiz Settings</h3>
                            <div class="setting-item">
                                <label>Default Timer (seconds)</label>
                                <input type="number" id="default-timer" value="30" min="10" max="120" onchange="saveSettings();">
                            </div>
                            <div class="setting-item">
                                <label>Show Correct Answers</label>
                                <input type="checkbox" id="show-answers" checked onchange="saveSettings();">
                            </div>
                            <div class="setting-item">
                                <label>üìö Save Generated Questions</label>
                                <input type="checkbox" id="save-questions" checked onchange="saveSettings();">
                                <small class="setting-help">Automatically save all generated questions to review history for later practice</small>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>ü§ñ Model Selection & Preferences</h3>
                            <div class="setting-item">
                                <label>Available Models</label>
                                <button class="btn btn-secondary" onclick="refreshAvailableModels()">üîÑ Refresh Available Models</button>
                                <div id="available-models-list" class="models-list">
                                    <p class="loading-text">Click "Refresh" to load available models...</p>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label>Preferred Model for MCQ Generation</label>
                                <select id="preferred-mcq-model" onchange="saveModelPreferences();">
                                    <option value="">Auto-select best available model</option>
                                </select>
                                <small class="setting-help">Choose your preferred model for generating quiz questions</small>
                            </div>
                            <div class="setting-item">
                                <label>Preferred Model for Expert/Thinking Mode</label>
                                <select id="preferred-thinking-model" onchange="saveModelPreferences();">
                                    <option value="">Auto-select best thinking model</option>
                                </select>
                                <small class="setting-help">Choose your preferred model for complex reasoning tasks</small>
                            </div>
                            <div class="setting-item">
                                <label>Model Selection Strategy</label>
                                <select id="model-selection-strategy" onchange="saveModelPreferences();">
                                    <option value="intelligent">ü§ñ Intelligent (Recommended)</option>
                                    <option value="user_preference">üë§ User Preference Only</option>
                                    <option value="first_available">‚ö° First Available</option>
                                </select>
                                <small class="setting-help">How the system should choose models when multiple options are available</small>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>&copy; 2025 Knowledge App. All rights reserved.</p>
        </footer>
    </div>

    <!-- üõ°Ô∏è SECURITY FIX #17: Client-Side Input Sanitization -->
    <script src="client_input_sanitizer.js"></script>
    <!-- üîí SECURITY FIX #16: Secure API Key Management -->
    <script src="secure_api_key_client.js"></script>
    <!-- API Key Persistence Fix (deprecated but kept for compatibility) -->
    <script src="api_key_persistence_fix.js"></script>
    <script src="app.js"></script>
</body>
</html>
